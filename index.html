  <!doctype html>
  <html lang="it">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>One Piece — Squadre</title>
  <style>
  :root { 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    --primary: #4f74ff;
    --secondary: #2b356f;
    --highlight: #ffdd57;
    --bg-card: #1a2040;
    --bg-body: #0b1020;
    --pill-cap: #ff4f4f89;
    --pill-vice: #4f95ff93;
    --pill-fighter: #4fff7e7c;
    --glow-bounty: rgba(255,215,0,0.6);
    --glow-devil: rgba(255,0,255,0.6);
    --glow-both: rgba(0, 255, 255, 0.685);
    --glow-conqueror: rgba(255,0,0,0.6);
  }

/* --- Page Background --- */
body {
  margin: 0;
  font-family: 'Pirata One', sans-serif;
  background: 
    url('images/parchment-texture.jpg') center/cover no-repeat fixed, /* old paper */
    linear-gradient(180deg, #f4fcff 0%, #1e3f66 100%); /* sky to ocean gradient */
  background-blend-mode: multiply;
  color: #3b2f1a;
}

/* Optional: add a subtle overlay of a map */
body::before {
  content: "";
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: url('images/one-piece-map.png') center/contain repeat;
  opacity: 0.15;
  z-index: -1;
  pointer-events: none;
}

/* Scrollbar Styling (optional) */
::-webkit-scrollbar {
  width: 10px;
}
::-webkit-scrollbar-track {
  background: rgba(245, 222, 179, 0.5);
}
::-webkit-scrollbar-thumb {
  background: #b88b57;
  border-radius: 5px;
}
::-webkit-scrollbar-thumb:hover {
  background: #a0713d;
}
  .attributes {
    background: rgba(255, 224, 186, 0.18);
    border: 2px solid #c49a6c;
    border-radius: 12px;
    padding: 10px;
    margin-top: 8px;
    box-shadow: inset 0 0 10px rgba(0,0,0,0.15);
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    justify-content: center;
  }

.attributes .pill, .grid .pill {
  font-family: 'Treasure Map Deadhand', cursive;
  font-weight: bold;
  background: linear-gradient(to bottom, #fef3c2, #f2d7b4);
  border: 2px solid #b88b57;
  color: #5a3e1b;
  box-shadow: 0 2px 4px rgba(0,0,0,0.25);
}

  .attributes .pill:hover {
    transform: scale(1.05);
    background: linear-gradient(to bottom, #fff7e6, #f5d9b0);
  }

  .aliases {
    margin-top: 8px;
    font-style: italic;
    font-size: 12px;
    opacity: 0.85;
    text-align: center;
  }


  .card-container { 
    display: flex; 
    gap: 20px; 
    flex-wrap: wrap; 
    justify-content: center; 
    margin-bottom: 20px; 
  }

.card {
  position: relative;
  overflow: visible;
  width: min(320px, 92vw);
  background: linear-gradient(145deg, #f4e0c3, #d9b98b); /* aged paper gradient */
  border-radius: 20px;
  box-shadow: 0 10px 30px rgba(0,0,0,.6);
  cursor: pointer;
  transition: transform 0.3s, box-shadow 0.3s, filter 0.3s;
  font-family: 'Treasure Map Deadhand', cursive; /* pirate style font */
  color: #3b2f1a;
  border: 2px solid #b88b57;
}
  .card:hover { 
    transform: translateY(-8px) scale(1.02); 
    box-shadow: 0 20px 50px rgba(0,0,0,.8); 
    filter: brightness(1.05);
  }
  /* Conqueror's Haki Lightning Aura */

/* Conqueror's Haki Lightning Aura - always visible */
.card-conqueror {
  position: relative; 
  overflow: visible;
  box-shadow: 0 0 35px 12px var(--glow-conqueror); /* stronger by default */
  transition: transform 0.3s, box-shadow 0.3s, filter 0.3s;
}
.card-conqueror::before {
  content: "";
  position: absolute;
  top: -30px;
  left: -30px;
  right: -30px;
  bottom: -30px;
  background: url('images/light.png') repeat;
  background-size: contain;
  z-index: -1;
  pointer-events: none;
  filter: brightness(1.5) blur(2px);
  opacity: 0.8;
  animation: flashAura 1s infinite;
}

@keyframes flashAura {
  0%   { opacity: 0.7; }
  10%  { opacity: 1; }
  20%  { opacity: 0.4; }
  30%  { opacity: 0.8; }
  40%  { opacity: 0.5; }
  50%  { opacity: 1; }
  60%  { opacity: 0.3; }
  70%  { opacity: 0.9; }
  80%  { opacity: 0.6; }
  90%  { opacity: 1; }
  100% { opacity: 0.7; }
}



/* Hover just makes it stronger and moves the card */
.card-conqueror:hover {
  transform: translateY(-8px) scale(1.02);
  box-shadow: 0 0 35px 12px var(--glow-conqueror), 0 20px 50px rgba(0,0,0,.8);
  filter: brightness(1.05);
}



/* Hero Image */
.hero {
  width: 100%; /* fill card width */
  height: auto;
  max-height: 380px; /* increased from your current value */
  object-fit: contain; /* keeps proportions without cropping */
  display: block;
  margin: 0 auto;
  border: 4px solid #8B4513; /* pirate poster frame look */
  border-radius: 10px;
  box-shadow: 0 0 20px rgba(0,0,0,0.5);
}


 .content {
  padding: 20px 22px 24px;
  background: rgba(255, 248, 220, 0.85); /* slightly transparent parchment look */
  border-radius: 0 0 20px 20px;
  box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
  border-top: 2px solid #b88b57;
}

h1 {
  margin: 0 0 6px;
  font-size: 26px;
  color: #b84100; /* bold pirate red */
  text-shadow: 2px 2px 0 #fef3c2, 0 0 6px rgba(0,0,0,.5);
}

.meta {
  opacity: 0.9;
  font-size: 14px;
  font-style: italic;
  color: #4b3621;
  text-shadow: 1px 1px 0 #fff3c2;
  margin-bottom: 10px;
  text-align: center;
}

  .grid { 
    display: grid; 
    grid-template-columns: 1fr 1fr; 
    gap: 12px; 
    margin: 12px 0; 
  }

  .pill { 
    background: var(--secondary); 
    padding: 8px 10px; 
    border-radius: 999px; 
    text-align: center; 
    font-size: 13px; 
    transition: background 0.2s; 
  }
  .pill:hover { 
    background: var(--primary); 
  }

  .actions { 
    display: flex; 
    gap: 12px; 
    margin-bottom: 12px; 
    flex-wrap: wrap; 
    justify-content: center; 
  }
  button { 
    cursor: pointer; 
    border: 0; 
    border-radius: 999px; 
    padding: 12px 20px; 
    font-weight: 700; 
    background: var(--primary); 
    color: white; 
    transition: background 0.2s, transform 0.2s; 
  }
  button:hover { 
    background: #627fff; 
    transform: scale(1.05);
  }
  button.secondary { 
    background: var(--secondary); 
  }

  #counter { 
    margin-top: 8px; 
    font-size: 14px; 
    opacity: .9; 
    text-align: center; 
    color: var(--highlight);
  }

  .footer { 
    opacity: .6; 
    font-size: 12px; 
    text-align: center; 
    padding: 10px 0 18px; 
  }

  .teams { 
    display: flex; 
    gap: 40px; 
    margin-top: 20px; 
    flex-wrap: wrap; 
    justify-content: center; 
  }

  .team { 
    background: linear-gradient(145deg, #013c53, #013c53); 
    padding: 16px; 
    border-radius: 20px; 
    width: 320px; 
    box-shadow: 0 10px 30px rgba(245, 237, 237, 0.5); 
    transition: transform 0.2s; 
  }
  .team:hover { 
    transform: translateY(-5px); 
  }
  .team h2 { 
    margin-top: 0; 
    text-align: center; 
    color: var(--highlight); 
    font-weight: 700; 
    font-size: 20px;
    text-shadow: 0 2px 4px rgba(137, 94, 255, 0.6);
  }

  .role { 
    margin: 8px 0; 
    background-color: #4f74ff;
    padding: 10px 12px; 
    border-radius: 12px; 
    font-size: 14px; 
    cursor: pointer; 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    transition: background 0.2s, transform 0.2s; 
  }
  .role.capitano { background: var(--pill-cap); color: rgb(245, 232, 255); }
  .role.vice { background: var(--pill-vice); color: rgb(246, 209, 255); }
  .role.combattente { background: var(--pill-fighter); color: #ffc7ff; }
  .role:hover { 
    opacity: 0.5; 
    transform: scale(1.02);
  }
  .selected { 
    outline: 3px solid var(--highlight); 
  }

  .role-menu { 
    position: absolute; 
    background: #e8dcfd; /* solid background */
    border: 1px solid var(--primary); 
    border-radius: 12px; 
    padding: 8px; 
    display: none; 
    z-index: 10; 
    box-shadow: 0 8px 20px rgba(255, 32, 225, 0.7);
    transition: opacity 0.5s ease;
}

  .role-menu div { 
    padding: 8px 12px; 
    cursor: pointer; 
    border-radius: 8px; 
  }
  .role-menu div:hover { 
    background: var(--primary); 
    color: rgb(172, 171, 248); 
  }

.legend {
  display: flex;
  flex-wrap: wrap;
  gap: 14px;
  justify-content: center;
  align-items: center;
  font-family: 'One Piece', sans-serif;
  font-size: 14px;
  background: rgba(88, 48, 182, 0.6);
  padding: 10px 15px;
  border: 3px solid #d4a373;
  border-radius: 12px;
  box-shadow: 0 0 10px rgba(0,0,0,0.5);
  color: #ffd66b; /* 🌟 colore testo leggibile */
  text-shadow: 1px 1px 2px #000; /* più contrasto */
}

.legend h3 {
  margin: 0 100% 8px 0;
  font-size: 16px;
  text-decoration: underline;
  color: #ffeb9c; /* leggermente più chiaro per il titolo */
  text-shadow: 2px 2px 3px #000;
}

.legend-box {
  display: inline-block;
  width: 20px;
  height: 20px;
  border-radius: 4px;
  margin-right: 6px;
  box-shadow: 0 0 6px rgba(255,255,255,0.4);
}

.glow-bounty { background: gold; box-shadow: 0 0 10px gold; }
.glow-devil { background: violet; box-shadow: 0 0 10px violet; }
.glow-both { background: rgba(0, 255, 255, 0.685); box-shadow: 0 0 10px gold; }
.glow-conqueror { background: red; box-shadow: 0 0 10px red; }
.glow-lightning { 
  background: url('images/light.png') center/cover no-repeat; 
  border: 1px solid rgba(255,255,255,0.5);
}

/* ===== VS Banner ===== */
#vsBanner {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.6);
  opacity: 0;
  font-family: 'Treasure Map Deadhand', cursive;
   font-size: clamp(36px, 8vw, 100px);
  font-weight: 900;
  letter-spacing: 6px;
  color: #ffdd57;
  padding: 12px 24px;
  border: 4px solid #d4a373;
  border-radius: 24px;
  background: radial-gradient(ellipse at center, rgba(0,0,0,0.75), rgba(0,0,0,0.35) 60%, rgba(0,0,0,0) 90%);
  text-shadow: 0 0 20px red, 0 0 40px #ff0000, 0 0 60px #ff6600;
  box-shadow: 0 0 40px rgba(255, 102, 0, 0.8), inset 0 0 20px rgba(255, 221, 87, 0.4);
  transition: transform 0.6s ease, opacity 0.6s ease;
  z-index: 9999;
  pointer-events: none;
}

#vsBanner.show {
  opacity: 1;
  transform: translate(-50%, -50%) scale(1);
  animation: pulseVS 1s infinite alternate, shakeVS 0.6s ease-in-out 1;
}

@keyframes pulseVS {
  from { text-shadow: 0 0 20px red, 0 0 40px #ff0000; }
  to   { text-shadow: 0 0 40px yellow, 0 0 80px orange; }
}

@keyframes shakeVS {
  0%   { transform: translate(-50%, -50%) scale(1) rotate(0deg); }
  25%  { transform: translate(calc(-50% + 6px), calc(-50% - 4px)) scale(1.02) rotate(-1deg); }
  50%  { transform: translate(calc(-50% - 5px), calc(-50% + 5px)) scale(1.02) rotate(1deg); }
  75%  { transform: translate(calc(-50% + 4px), calc(-50% + 2px)) scale(1.01) rotate(-0.5deg); }
  100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); }
}
/* ===== Arena Mode ===== */

#arenaOverlay {
  display: none; /* toggled by JS */
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  flex-direction: column;
  justify-content: center; /* center vertically */
  align-items: center;
  gap: 24px;
  padding: 24px;
  width: min(960px, 90vw);
  max-height: 90vh;
  overflow-y: auto;
  background: linear-gradient(135deg, #1f1f2e, #2c2c44);
  border: 3px solid #ffdd57;
  border-radius: 20px;
  box-shadow: 0 0 40px rgba(255, 221, 87, 0.5), inset 0 0 20px rgba(255, 215, 0, 0.2);
  color: #fff;
  font-family: 'Treasure Map Deadhand', cursive;
  z-index: 10000;
  text-align: center;
  transition: transform 0.4s ease, opacity 0.4s ease;
}



#arenaTop{
  width:min(960px, 95vw);
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-family:'Treasure Map Deadhand', cursive;
  font-weight:700;
  letter-spacing:1px;
  text-shadow:0 0 8px #000;
    flex-direction: column;
  gap: 8px;
  text-align: center;;
}
@media(min-width: 600px) {
  #arenaTop {
    flex-direction: row;
    justify-content: space-between;
    text-align: left;
  }
}

#arenaDuelCounter{ font-size:18px; opacity:.9; }
#arenaScore{ font-size:20px; }

#duelWrapper{
  width:min(960px, 95vw);
  background:rgba(20,20,20,.7);
  border:3px solid #d4a373;
  border-radius:20px;
  padding:24px;
  box-shadow:0 0 24px rgba(0,0,0,.4), inset 0 0 12px rgba(0,0,0,.4);
}

.duel-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 24px;
  text-align: center;
}

@media(min-width: 600px) {
  .duel-container {
    flex-direction: row;
    gap: 48px;
  }
}

.duel-side {
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
  border-radius: 16px;
  background: linear-gradient(145deg, #3b3b5c, #202040);
  padding: 8px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.5);
}

.duel-side img {
  width: 60vw;
  max-width: 220px;
  height: auto;
  border-radius: 12px;
  border: 2px solid #ffdd57;
}

.duel-side:hover {
  transform: scale(1.08);
  box-shadow: 0 0 28px rgba(255, 221, 87, 0.8);
  filter: brightness(1.1);
}

.duel-role {
  font-size: 28px;
  font-weight: 900;
  color: #ffdd57;
  text-shadow: 0 0 12px #000, 0 0 20px #ffbb00;
  white-space: nowrap;
  margin: 0 12px;
}

.duel-side img:hover{
  transform:scale(1.06);
  box-shadow:0 0 22px rgba(255,215,0,.8);
  filter:brightness(1.05);
}

.char-name{
  margin-top:8px;
  font-weight:800;
  font-size:18px;
  text-shadow:0 0 6px #000;
}

.arena-btn {
  cursor: pointer;
  border: 0;
  border-radius: 12px;
  padding: 14px 24px;
  font-weight: 800;
  background: linear-gradient(135deg, #ffcc33, #ffaa00);
  color: #1b1b2f;
  font-size: 16px;
  box-shadow: 0 6px 16px rgba(255, 170, 0, 0.6);
  transition: all 0.2s;
}

.arena-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 0 24px rgba(255, 221, 87, 0.9);
  filter: brightness(1.15);
}


#arenaBottom{ margin-top:8px; 
width: 100%; /* full width on small screens */
  max-width: 300px;
}



  </style>
  </head>
  <body>

  <div class="actions">
    <button id="randomBtn">🎲 Random</button>
    <button id="noRepeatBtn" class="secondary">🔁 No ripetizioni</button>
    
  </div>
  <div id="counter">0 / 0</div>
  <div class="card-container" id="cards"></div>

  <div class="teams">
    <div class="team" id="team1">
      <h2>Giocatore 1</h2>
      <div class="role capitano" data-role="Capitano">Capitano: —</div>
      <div class="role vice" data-role="Vice Capitano">Vice Capitano: —</div>
      <div class="role combattente" data-role="Primo Combattente">Primo Combattente: —</div>
      <div class="role combattente" data-role="Secondo Combattente">Secondo Combattente: —</div>
      <div class="role combattente" data-role="Terzo Combattente">Terzo Combattente: —</div>
    </div>
    <div class="team" id="team2">
      <h2>Giocatore 2</h2>
      <div class="role capitano" data-role="Capitano">Capitano: —</div>
      <div class="role vice" data-role="Vice Capitano">Vice Capitano: —</div>
      <div class="role combattente" data-role="Primo Combattente">Primo Combattente: —</div>
      <div class="role combattente" data-role="Secondo Combattente">Secondo Combattente: —</div>
      <div class="role combattente" data-role="Terzo Combattente">Terzo Combattente: —</div>
    </div>
  </div>

  <div class="role-menu" id="roleMenu"></div>

 <div class="legend">
  <div><span class="legend-box glow-bounty"></span> Bounty > 2.5B</div>
  <div><span class="legend-box glow-devil"></span> Devil Fruit</div>
  <div><span class="legend-box glow-both"></span> Bounty + Devil Fruit</div>
  <div><span class="legend-box glow-conqueror"></span> Conqueror’s Haki</div>
</div>


  <div class="footer">One Piece fan project — solo per uso personale</div>

  <script>
  let data = [];
  let pool = [];
  let totalCharacters = 0;
  let currentPlayer = 1;
  let currentChar = null;

  const $ = (id) => document.getElementById(id);

  async function load() {
    const res = await fetch('characters.json');
    data = await res.json();
    totalCharacters = data.length;
    pool = [...data];
    showCards([randomFrom(data)]);
    updateCounter();
  }

  function randomFrom(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
  }

// cache per evitare controlli ripetuti
const _webpExistenceCache = {};

// controlla se webp esiste (tramite caricamento immagine, risolve true/false)
function checkWebpExists(webpPath) {
  return new Promise((resolve) => {
    if (_webpExistenceCache.hasOwnProperty(webpPath)) {
      return resolve(_webpExistenceCache[webpPath]);
    }
    const t = new Image();
    t.onload = () => { _webpExistenceCache[webpPath] = true; resolve(true); };
    t.onerror = () => { _webpExistenceCache[webpPath] = false; resolve(false); };
    // inizio richiesta
    t.src = webpPath + (webpPath.includes('?') ? '&' : '?') + 'v=1'; // cache-buster facoltativo
  });
}

// crea elemento immagine responsivo: usa .webp solo se esiste, altrimenti il path originale
async function createResponsiveImage(imgPath, alt = '', cls = '') {
  const webpPath = imgPath.replace(/\.(jpg|jpeg|png)$/i, '.webp');
  const hasWebp = await checkWebpExists(webpPath);

  if (hasWebp) {
    const picture = document.createElement('picture');

    const source = document.createElement('source');
    source.srcset = webpPath;
    source.type = 'image/webp';

    const img = document.createElement('img');
    if (cls) img.className = cls;
    img.src = webpPath;
    img.alt = alt;
    img.loading = 'lazy';

    picture.appendChild(source);
    picture.appendChild(img);
    return picture;
  } else {
    const img = document.createElement('img');
    if (cls) img.className = cls;
    img.src = imgPath;
    img.alt = alt;
    img.loading = 'lazy';
    return img;
  }
}

// showCards ora è async e crea i nodi DOM — incolla al posto della tua versione corrente
async function showCards(chars) {
  const container = $('cards');
  container.innerHTML = "";
  for (const char of chars) {
    const card = document.createElement("div");
    card.className = "card";

    // Glow effects (stesso tuo codice)
    if (char.bounty && parseInt(String(char.bounty).replace(/\D/g,'')) > 2500000000 
        && char.devil_fruit && char.conqueror_haki) {
      card.classList.add("conqueror", "card-conqueror");
    } else if (char.conqueror_haki) {
      card.classList.add("conqueror", "card-conqueror");
    } else if (char.bounty && parseInt(String(char.bounty).replace(/\D/g,'')) > 2500000000 
               && char.devil_fruit) {
      card.style.boxShadow = `0 0 20px 5px var(--glow-both)`;
    } else if (char.bounty && parseInt(String(char.bounty).replace(/\D/g,'')) > 2500000000) {
      card.style.boxShadow = `0 0 20px 5px var(--glow-bounty)`;
    } else if (char.devil_fruit) {
      card.style.boxShadow = `0 0 20px 5px var(--glow-devil)`;
    }

    // crea immagine responsiva (usa webp se esiste)
    const imgEl = await createResponsiveImage(char.image, char.name, 'hero');

    // crea il contenuto testuale (usa innerHTML per semplicità)
    const content = document.createElement('div');
    content.className = 'content';
    content.innerHTML = `
      <h1>${char.name}</h1>
      <div class="meta">${char.crew || '—'}</div>
      <div class="grid">
        <div class="pill">${char.role || '—'}</div>
        <div class="pill">${char.bounty ? `Bounty: ${char.bounty}` : 'Bounty: —'}</div>
      </div>
      <div class="grid">
        <div class="pill">${(char.aliases && char.aliases.length) ? char.aliases.join(', ') : '—'}</div>
        <div class="pill">Devil fruit: ${char.devil_fruit ?? '—'}</div>
      </div>
    `;

    card.appendChild(imgEl);
    card.appendChild(content);

    card.addEventListener('click', (e) => showRoleMenu(e, char));
    container.appendChild(card);
  }
}

// renderArenaDuel diventa async (viene chiamata senza await ma funziona)
async function renderArenaDuel() {
  const d = arenaState.duels[arenaState.idx];

  // Top bar
  $('arenaDuelCounter').textContent =
    `Duello ${arenaState.idx + 1} / ${arenaState.duels.length}`;
  $('arenaScore').textContent =
    `Giocatore 1 ${arenaState.score1} — ${arenaState.score2} Giocatore 2`;

  // svuota e costruisci con DOM
  const wrapper = $('duelWrapper');
  wrapper.innerHTML = ""; // svuota

  const duelContainer = document.createElement('div');
  duelContainer.className = 'duel-container';

  // lato 1
  const pick1 = document.createElement('div');
  pick1.className = 'duel-side';
  pick1.id = 'pick1';
  const img1 = await createResponsiveImage(d.char1.image, d.char1.name);
  const name1 = document.createElement('div');
  name1.className = 'char-name';
  name1.textContent = d.char1.name;
  pick1.appendChild(img1);
  pick1.appendChild(name1);

  // ruolo (al centro)
  const roleDiv = document.createElement('div');
  roleDiv.className = 'duel-role';
  roleDiv.innerHTML = `⚔️ ${d.role} ⚔️`;

  // lato 2
  const pick2 = document.createElement('div');
  pick2.className = 'duel-side';
  pick2.id = 'pick2';
  const img2 = await createResponsiveImage(d.char2.image, d.char2.name);
  const name2 = document.createElement('div');
  name2.className = 'char-name';
  name2.textContent = d.char2.name;
  pick2.appendChild(img2);
  pick2.appendChild(name2);

  duelContainer.appendChild(pick1);
  duelContainer.appendChild(roleDiv);
  duelContainer.appendChild(pick2);

  wrapper.appendChild(duelContainer);

  // eventi click
  $('pick1').onclick = () => recordArenaWin(1);
  $('pick2').onclick = () => recordArenaWin(2);
  $('arenaClose').onclick = () => { $('arenaOverlay').style.display = 'none'; };
}


  function updateCounter() {
    const used = totalCharacters - pool.length;
    $('counter').textContent = `${used} / ${totalCharacters}`;
  }

  $('randomBtn').addEventListener('click', () => {
    showCards([randomFrom(data)]);
  });

  $('noRepeatBtn').addEventListener('click', () => {
    if (pool.length === 0) {
      alert("Tutti i personaggi sono stati mostrati! Si ricomincia.");
      pool = [...data];
    }
    const idx = Math.floor(Math.random() * pool.length);
    const pick = pool.splice(idx, 1)[0];
    showCards([pick]);
    updateCounter();
  });

  function showRoleMenu(e, char) {
    currentChar = char;
    const menu = $('roleMenu');
    menu.innerHTML = '';
    const team = currentPlayer === 1 ? 'team1' : 'team2';
    const roles = Array.from($(team).querySelectorAll('.role'));
    roles.forEach(roleDiv => {
      if (roleDiv.textContent.endsWith('—')) {
        const item = document.createElement('div');
        item.textContent = roleDiv.dataset.role;
        item.addEventListener('click', () => assignCharacterToRole(roleDiv));
        menu.appendChild(item);
      }
    });
    menu.style.display = 'block';
    menu.style.top = e.clientY + 'px';
    menu.style.left = e.clientX + 'px';
  }

  function assignCharacterToRole(roleDiv) {
    roleDiv.textContent = `${roleDiv.dataset.role}: ${currentChar.name}`;
    $('roleMenu').style.display = 'none';
    currentPlayer = currentPlayer === 1 ? 2 : 1;
     checkTeamsFull();
  }

  document.addEventListener('click', (e) => {
    if (!e.target.closest('.card') && !e.target.closest('#roleMenu')) {
      $('roleMenu').style.display = 'none';
    }
  });
  // ---- VS helpers ----
function isTeamFull(teamId) {
  return Array.from($(teamId).querySelectorAll('.role'))
    .every(r => !r.textContent.trim().endsWith('—'));
}

function teamsAreFull() {
  return isTeamFull('team1') && isTeamFull('team2');
}

function showVsBanner(text = 'VS') {
  const el = $('vsBanner');
  el.textContent = text;
  el.classList.add('show');
  clearTimeout(showVsBanner._hideTimer);
  showVsBanner._hideTimer = setTimeout(() => {
    el.classList.remove('show');
  }, 3000); // hide after 3s
}

function checkTeamsFull() {
  if (teamsAreFull()) {
    showVsBanner('VS');
    setTimeout(() => {
      startArenaAfterVS();
    }, 3000); // wait 3s for the VS banner
  }
}

// ===== Arena State =====
let arenaState = {
  duels: [],
  idx: 0,
  score1: 0,
  score2: 0
};

// Build pairs: Captain vs Captain, Vice vs Vice, ...
function buildDuels() {
  const roles1 = $('team1').querySelectorAll('.role');
  const roles2 = $('team2').querySelectorAll('.role');
  const arr = [];

  roles1.forEach((r1, i) => {
    const r2 = roles2[i];
    if (!r1 || !r2) return;

    const name1 = (r1.textContent.split(': ')[1] || '').trim();
    const name2 = (r2.textContent.split(': ')[1] || '').trim();

    const char1 = data.find(c => c.name === name1);
    const char2 = data.find(c => c.name === name2);

    if (char1 && char2) {
      // Prefer data-role attribute; fallback to text before ':'
      const roleLabel = r1.dataset.role || (r1.textContent.split(':')[0] || '').trim();
      arr.push({ role: roleLabel, char1, char2 });
    }
  });

  return arr;
}

function startArenaAfterVS() {
  const duels = buildDuels();
  if (!duels.length) return;

  arenaState = { duels, idx: 0, score1: 0, score2: 0 };
  const overlay = $('arenaOverlay');
  overlay.style.opacity = 0;
  overlay.style.display = 'flex';
  
  renderArenaDuel();

  // Fade in
  setTimeout(() => {
    overlay.style.transition = 'opacity 0.5s';
    overlay.style.opacity = 1;
  }, 50);
}


async function renderArenaDuel() {
  const d = arenaState.duels[arenaState.idx];

  // Top bar
  $('arenaDuelCounter').textContent =
    `Duello ${arenaState.idx + 1} / ${arenaState.duels.length}`;
  $('arenaScore').textContent =
    `Giocatore 1 ${arenaState.score1} — ${arenaState.score2} Giocatore 2`;

  // svuota contenitore
  const wrapper = $('duelWrapper');
  wrapper.innerHTML = "";

  // contenitore principale
  const duelContainer = document.createElement('div');
  duelContainer.className = 'duel-container';

  // lato 1
  const pick1 = document.createElement('div');
  pick1.className = 'duel-side';
  pick1.id = 'pick1';
  const img1 = await createResponsiveImage(d.char1.image, d.char1.name);
  const name1 = document.createElement('div');
  name1.className = 'char-name';
  name1.textContent = d.char1.name;
  pick1.appendChild(img1);
  pick1.appendChild(name1);

  // ruolo (al centro)
  const roleDiv = document.createElement('div');
  roleDiv.className = 'duel-role';
  roleDiv.textContent = `⚔️ ${d.role} ⚔️`;

  // lato 2
  const pick2 = document.createElement('div');
  pick2.className = 'duel-side';
  pick2.id = 'pick2';
  const img2 = await createResponsiveImage(d.char2.image, d.char2.name);
  const name2 = document.createElement('div');
  name2.className = 'char-name';
  name2.textContent = d.char2.name;
  pick2.appendChild(img2);
  pick2.appendChild(name2);

  // monta tutto
  duelContainer.appendChild(pick1);
  duelContainer.appendChild(roleDiv);
  duelContainer.appendChild(pick2);
  wrapper.appendChild(duelContainer);

  // eventi click
  $('pick1').onclick = () => recordArenaWin(1);
  $('pick2').onclick = () => recordArenaWin(2);
  $('arenaClose').onclick = () => { $('arenaOverlay').style.display = 'none'; };
}

function recordArenaWin(team) {
  if (team === 1) arenaState.score1++; else arenaState.score2++;

  // Advance
  arenaState.idx++;
  if (arenaState.idx >= arenaState.duels.length) {
    endArenaBattle();
  } else {
    renderArenaDuel();
  }
}

function endArenaBattle() {
  const { score1, score2 } = arenaState;
  let msg = `🤝 Pareggio (${score1} - ${score2})`;
  if (score1 > score2) msg = `🏴‍☠️ Giocatore 1 vince! (${score1} - ${score2})`;
  if (score2 > score1) msg = `🏴‍☠️ Giocatore 2 vince! (${score2} - ${score1})`;

  $('arenaDuelCounter').textContent = '';
  $('arenaScore').textContent = '';
  $('duelWrapper').innerHTML = `
    <div style="text-align:center; padding:24px;">
      <h1 style="margin:0 0 12px 0;">${msg}</h1>
      <p style="opacity:.9">La battaglia è conclusa.</p>
    </div>
  `;
}

function generateTestTeams(size = 5) {
  if (!characters || characters.length === 0) {
    alert("⚠️ Personaggi non caricati!");
    return;
  }

  // Mischia i personaggi
  const shuffled = [...characters].sort(() => 0.5 - Math.random());

  // Taglia i primi `size*2`
  const selected = shuffled.slice(0, size * 2);

  // Divide in due squadre
  team1 = selected.slice(0, size);
  team2 = selected.slice(size, size * 2);

  // Mostra le squadre (se hai già funzioni che aggiornano la UI)
  renderTeams();

  console.log("✅ Squadre generate:");
  console.log("Team 1:", team1.map(c => c.name));
  console.log("Team 2:", team2.map(c => c.name));
}


  load();
  </script>
 <div id="vsBanner" aria-hidden="true">VS</div>
<!-- A R E N A -->
<div id="arenaOverlay" aria-hidden="true">
  <div id="arenaTop">
    <div id="arenaDuelCounter"></div>
    <div id="arenaScore"></div>
  </div>
  <div id="duelWrapper"></div>
  <div id="arenaBottom">
    <button id="arenaClose" class="arena-btn">Chiudi Arena</button>
  </div>
</div>

  </body>
  </html>
